var frames=0;var timer2,fpsContainer,fpsTimer,fpsTimer2,stage;var sprites={};var loaderTimer=null;var deleteThread=null;var deleteThread2=null;function loaderTimerStart(A){if(A&&loaderTimer){cleanLoaderTimer()}else{}loaderTimer=setTimeout(function(){console.log("战斗加载失败，回主城");$("#ajaxloading").hide();if(xGame.guide==true){guide.loadGuide()}else{xGame.loadWorld("city")}var B=appLanguage=="zh-cn"?"很抱歉，进入战场失败 (经验奖励不受影响)":"Fail to enter (Reward have been obtained) ";xGame.toast.show(B)},20000)}function cleanLoaderTimer(){if(loaderTimer){clearTimeout(loaderTimer);loaderTimer=null}if(deleteThread){clearTimeout(deleteThread);deleteThread=null}if(deleteThread2){clearTimeout(deleteThread2);deleteThread2=null}}var battleLoader=null;var BattleLoader=function(){this.imagelist=[];this.next=null;this._index=-1;this.dom_progress=null};BattleLoader.prototype.init=function(B){this.imagelist=B.imagelist;this.next=B.next;this.dom_progress=$("#worldloading_progress");var A=this;if(appFileSystem==null){window.requestFileSystem(LocalFileSystem.PERSISTENT,0,function(C){appFileSystem=C;cached_path=appFileSystem.root.fullPath.replace("Documents","");A.load();A=null},function(){location.reload()})}else{A.load();A=null}};BattleLoader.prototype.load=function(){var C=this;var F=function(){C._index=-1;C.next();C.next=null;C.imagelist.length=0;C.dom_progress.html(lang("battle_ready"));C.dom_progress=null};if(C.imagelist.length==0){F();return}C._index++;if(typeof C.imagelist[C._index]=="undefined"){F();return}C.dom_progress.html('<em class="now">'+(C._index+1)+'</em> / <em class="now">'+C.imagelist.length+"</em>");var B=C.imagelist[C._index];var D=B.substring(B.lastIndexOf("/")+1);var A="sg_cache/"+D;var E=function(){console.log("Download Error: "+B);C._index--;C.load()};appFileSystem.root.getFile(A,null,function(G){C.load()},function(){appFileSystem.root.getDirectory("sg_cache",{create:true},function(){var G=new FileTransfer();G.download(B,cached_path+"Documents/sg_cache/"+D,function(H){C.load();loaderTimerStart(true)},E)},E)})};(function(){battleWorldClass=function(){this.battledata=null;this.resultdata=null;this.callback=null;this.k=0;this.t=null;this.imagelist=null;this.skip=false;this.bgname="";this.skipresult=null;this.endfunc=null;this.round=0;this.leave=true;this.allowSkip=true;this.refightSkip=true;this.timeoutArr=[];this.battleStringData=null;this.starbattle_huihe=null;this.countrygvg=null;this.fieldname=null;this.nowdata=null};battleWorldClass.prototype={init:function(K,B,J,I,C,D){var H=this;if(D!=undefined){H.countrygvg=D;H.fieldname=K.field}if(C&&parseInt(player.info.level)<20&&parseInt(K.info.first)==1){H.allowSkip=false}if(H.allowSkip==false&&parseInt(K.info.first)==1&&parseInt(K.info.win)==-1){H.refightSkip=false}else{H.refightSkip=true}this.leave=false;loaderTimerStart();$("#worldloading").children(".main").append('<div id="worldloading_progress"></div>');if(typeof cordova!="undefined"){var F=[];for(var G in K.battle.leftteam){if(K.battle.leftteam[G]==null){continue}var A=K.battle.leftteam[G].image;var E=xGame.hero(A,2,false);if(E.indexOf("http")!=-1){F.push(E)}}for(var G in K.battle.rightteam){if(K.battle.rightteam[G]==null){continue}var A=K.battle.rightteam[G].image;if(A.indexOf("worldboss")!=0&&A.indexOf("countryboss")!=0&&A.indexOf("newyearboss")!=0&&A.indexOf("elk_boss")!=0){var E=xGame.hero(A,2,false);if(E.indexOf("http")!=-1){F.push(E)}}}if(battleLoader==null){battleLoader=new BattleLoader()}battleLoader.init({imagelist:F,next:function(){H.initImages(K,B,J,I,true)}})}else{H.initImages(K,B,J,I,false)}},initImages:function(I,A,H,G,C){if(gAudio){gAudio.playbgm("battle_bgm")}var F=this;F.endfunc=G?G:null;F.battledata=I.battle;F.nowdata=I;F.battleStringData=JSON.stringify(I.battle);F.resultdata=I.info;F.starbattle_huihe=I.round_kai;F.skipresult={left:F.battledata.leftresult,right:F.battledata.rightresult};F.callback=A;var D=staticUrl+"img/battle/battle_bg.jpg";if(H=="pvp"){D=staticUrl+"img/plugin/battle_pvp_bg.jpg"}if(H=="war"){D=staticUrl+"img/plugin/battle_war_bg.jpg"}else{if(H=="worldboss"){D=staticUrl+"img/battle/battle_worldboss.jpg"}else{if(H=="treasure"){D=staticUrl+"img/plugin/battle_treasure_bg.jpg"}else{if(H=="tower"){D=staticUrl+"img/battle/battle_tower_bg.jpg"}else{if(H=="heaven"){D=staticUrl+"img/plugin/battle_heaven_bg.jpg"}else{if(H.indexOf("sanctum")==0){if(H.indexOf("sanctum5")==0||H.indexOf("sanctum6")==0||H.indexOf("sanctum7")==0||H.indexOf("sanctum8")==0||H.indexOf("sanctum9")==0||H.indexOf("sanctum10")==0){D=staticUrl+"img/plugin/battle_"+H+"_bg.jpg"}else{D=staticUrl+"img/battle/battle_"+H+"_bg.jpg"}}else{if(H.indexOf("pacify")==0){D=staticUrl+"img/plugin/battle_"+H+"_bg.jpg"}else{if(H=="generaltask"){D=staticUrl+"img/pop/battle_generaltask_bg.jpg"}else{if(H=="worldarena"){D=staticUrl+"img/plugin/battle_worldarena.jpg"}else{if(H=="countryboss"){D=staticUrl+"img/battle/battle_countryboss.jpg"}else{if(H=="overseastrade"){D=staticUrl+"img/plugin/battle_overseastrade_bg.jpg"}else{if(H=="champions"){D=staticUrl+"img/battle/battle_champions.jpg"}else{if(H=="newyearboss"){D=staticUrl+"img/plugin/battle_newyearboss.jpg"}else{if(H>0&&H<=6){D=staticUrl+"img/battle/battle_bg"+H+".jpg"}else{if(H>6){D="http://img2.hanjiangsanguo.com/hjimg/battle/battle_bg"+H+".jpg"}else{if(H.indexOf("herothrone")==0){D=staticUrl+"img/battle/battle_"+H+".jpg"}else{if(H=="attackJapan"){D=ximg(staticUrl+"img/plugin/battle_"+H+"_bg.jpg")}else{if(H=="ladder"){D=staticUrl+"img/plugin/ladderwarpop_battle_bg.jpg"}else{if(H=="exploit"){D=staticUrl+"img/plugin/exploitstonepop_battle_bg.jpg"}else{if(H=="threepk"){D=staticUrl+"img/plugin/threecontest_battle_bg.jpg"}else{if(H=="scramble"){D=staticUrl+"img/plugin/scramblepop_battle_bg.jpg"}else{if(H=="countrymine"){D=staticUrl+"img/plugin/countrymine_bg.jpg"}else{if(H=="countrygvg"){D=staticUrl+"img/plugin/countrygvg_bg.jpg"}else{if(H=="eightdiagram"){D=staticUrl+"img/plugin/eightdiagram_bg.jpg"}else{if(H=="countrymap"){D=staticUrl+"img/plugin/countrymap_battle_bg.jpg"}else{if(H=="seizemap"){D=staticUrl+"img/plugin/treasurepop_battle_bg.jpg"}}}}}}}}}}}}}}}}}}}}}}}}}}F.bgname=D;F.imagelist=[{id:"bg",size:1,src:ximg(F.bgname)},{id:"bar_bg",size:1,src:staticUrl+"img/battle/bar_bg.png"},{id:"bar_blood",size:1,src:staticUrl+"img/battle/bar_blood.png"},{id:"bar_power",size:1,src:staticUrl+"img/battle/bar_power.png"},{id:"bar_skill",size:1,src:staticUrl+"img/battle/bar_skill.png"},{id:"label_hit",size:7,src:staticUrl+"img/battle/label_hit.png"},{id:"label_miss",size:7,src:staticUrl+"img/battle/label_miss.png"},{id:"label_viewbreak",size:7,src:staticUrl+"img/battle/label_viewbreak.png"},{id:"label_shadow",size:2,src:staticUrl+"img/battle/label_shadow.png"},{id:"num",size:7,src:staticUrl+"img/battle/numtext.png"},{id:"poweranim",size:7,src:staticUrl+"img/battle/poweranim.png"},{id:"attackanim",size:7,src:staticUrl+"img/battle/attackanim.png"},];for(var E in F.battledata.leftteam){if(F.battledata.leftteam[E]==null){continue}var B=F.battledata.leftteam[E].image;F.imagelist.push({id:"herostand_"+B,size:300,src:xGame.hero(B,1)});F.imagelist.push({id:"heroattack_"+B,size:300,src:xGame.hero(B,2,C)});F.imagelist.push({id:"herosuffer_"+B,size:300,src:xGame.hero(B,3)})}for(var E in F.battledata.rightteam){if(F.battledata.rightteam[E]==null){continue}var B=F.battledata.rightteam[E].image;if(B.indexOf("worldboss")==0){F.imagelist.push({id:"herostand_"+B,size:300,src:staticUrl+"img/worldboss/"+B+".png"});F.imagelist.push({id:"heroattack_"+B,size:300,src:staticUrl+"img/worldboss/"+B+".1.png"});F.imagelist.push({id:"herosuffer_"+B,size:300,src:staticUrl+"img/worldboss/"+B+".a.png"})}else{if(B.indexOf("countryboss")==0){F.imagelist.push({id:"herostand_"+B,size:300,src:staticUrl+"img/pop/"+B+"_stand.png"});F.imagelist.push({id:"heroattack_"+B,size:300,src:staticUrl+"img/pop/"+B+"_attack.png"});F.imagelist.push({id:"herosuffer_"+B,size:300,src:staticUrl+"img/pop/"+B+"_defense.png"})}else{if(B.indexOf("newyearboss")==0){F.imagelist.push({id:"herostand_"+B,size:300,src:ximg(staticUrl+"img/plugin/"+B+"_stand.png")});F.imagelist.push({id:"heroattack_"+B,size:300,src:ximg(staticUrl+"img/plugin/"+B+"_attack.png")});F.imagelist.push({id:"herosuffer_"+B,size:300,src:ximg(staticUrl+"img/plugin/"+B+"_defense.png")})}else{if(B.indexOf("elk_boss")==0){F.imagelist.push({id:"herostand_"+B,size:300,src:ximg(staticUrl+"img/plugin/"+B+"_stand.png")});F.imagelist.push({id:"heroattack_"+B,size:300,src:ximg(staticUrl+"img/plugin/"+B+".a.png")});F.imagelist.push({id:"herosuffer_"+B,size:300,src:ximg(staticUrl+"img/plugin/"+B+".1.png")})}else{F.imagelist.push({id:"herostand_"+B,size:300,src:xGame.hero(B,1)});F.imagelist.push({id:"heroattack_"+B,size:300,src:xGame.hero(B,2,C)});F.imagelist.push({id:"herosuffer_"+B,size:300,src:xGame.hero(B,3)})}}}}}var J=new PxLoader();for(var E=0;E<F.imagelist.length;E++){J.addImage(F.imagelist[E].src)}J.addProgressListener(function(K){loaderTimerStart(true)});J.addCompletionListener(function(){if(battleWorld.leave==false){battleWorld.preparePage()}J=null;$("#worldloading").find("#worldloading_progress").remove()});J.start();F=null},preparePage:function(){var J=this;cleanLoaderTimer();var E=$("#world");if(E.find("#battleworld_page").length<=0){E.append($.template("battleworld_tmpl"));var G=E.find("#battleworld_page");var F=E.find("#backbtn");F.attr("class",J.allowSkip==false?"btn disable":"btn show");E.undelegate("#backbtn","touchend").delegate("#backbtn","touchend",function(Q){if(J.allowSkip==true){J.skip=true;$(this).hide()}else{$("#skip_battle_tip").show()}Q.preventDefault()});E.undelegate("#skip_battle_tip","webkitAnimationEnd").delegate("#skip_battle_tip","webkitAnimationEnd",function(Q){$(this).hide();Q.preventDefault()});E=null;if(typeof isdebug!="undefined"&&isdebug==true){frames=0;fpsTimer2=setInterval(function(){frames++},1000/60);fpsContainer=$("#fps");fpsTimer=setInterval(function(){fpsContainer.text("FPS:"+frames);frames=0},1000)}var N=G.find("#battle_vs");if(J.battledata.left_appellation&&J.battledata.left_appellation.head_frame&&J.battledata.right_appellation&&J.battledata.right_appellation.head_frame){G.find("#battle_vs").addClass("appellationbg");N.find(".left").css({"background":"url("+xGame.appellboxurl(J.battledata.left_appellation.head_frame)+")"});N.find(".right").css({"background":"url("+xGame.appellboxurl(J.battledata.right_appellation.head_frame)+")"});if(parseInt(J.battledata.left_appellation.title_quality)==0&&parseInt(J.battledata.left_appellation.title_id)>0){var P='<em class="ation_image" style="background-image:url('+xGame.glorynameImg(J.battledata.left_appellation.title_id)+');"></em>'}else{if(J.battledata.left_appellation.title==""){var P='<em class="'+(parseInt(J.battledata.right_appellation.title_quality)==8?"colorwords":"")+'" style="color:'+helper.getItemColor(J.battledata.right_appellation.title_quality)+'">'+lang("warena_no_rank")+"</em>"}else{var P='<em class="'+(parseInt(J.battledata.left_appellation.title_quality)==8?"colorwords":"")+'" style="color:'+helper.getItemColor(J.battledata.left_appellation.title_quality)+'">'+J.battledata.left_appellation.title+"</em>"}}if(parseInt(J.battledata.right_appellation.title_quality)==0&&parseInt(J.battledata.right_appellation.title_id)>0){var L='<em class="ation_image" style="background-image:url('+xGame.glorynameImg(J.battledata.right_appellation.title_id)+');"></em>'}else{if(J.battledata.right_appellation.title==""){var L='<em class="'+(parseInt(J.battledata.right_appellation.title_quality)==8?"colorwords":"")+'" style="color:'+helper.getItemColor(J.battledata.right_appellation.title_quality)+'">'+lang("warena_no_rank")+"</em>"}else{var L='<em class="'+(parseInt(J.battledata.right_appellation.title_quality)==8?"colorwords":"")+'" style="color:'+helper.getItemColor(J.battledata.right_appellation.title_quality)+'">'+J.battledata.right_appellation.title+"</em>"}}N.find(".left").html('<span class="title">'+P+'</span><span class="avatar avatar'+J.battledata.left_appellation.gender+'"></span><span class="level">Lv.'+J.battledata.left_role.level+'</span><span class="name">'+J.battledata.left_role.name+"</span>");N.find(".right").html('<span class="title">'+L+'</span><span class="avatar avatar'+J.battledata.right_appellation.gender+'"></span><span class="level">Lv.'+J.battledata.right_role.level+'</span><span class="name">'+J.battledata.right_role.name+"</span>")}else{if(J.battledata.left_role&&J.battledata.right_role){N.find(".left").html("<span>Lv."+J.battledata.left_role.level+"</span>"+J.battledata.left_role.name);N.find(".right").html("<span>Lv."+J.battledata.right_role.level+"</span>"+J.battledata.right_role.name)}else{G.find("#battle_vs").hide()}}if(typeof J.battledata["leftbuff"]!="undefined"){var H=["leftbuff","rightbuff"];var D=["jingzhun","mingzhong","kangyun"];for(var I=0;I<H.length;I++){for(var C=0;C<D.length;C++){var O=H[I];var A=D[C];var M=J.battledata[O];if(M[A]>0){if(parseInt(M[A])==8){G.find("."+O).children("."+A).addClass("colorwords").css("color",helper.getItemColor(M[A])).show()}else{G.find("."+O).children("."+A).removeClass("colorwords").css("color",helper.getItemColor(M[A])).show()}}}if(typeof J.battledata[H[I]].tree!="undefined"&&parseInt(J.battledata[H[I]].tree)>1){G.find("."+O).find(".tree").addClass("tree"+J.battledata[H[I]].tree).css("color",helper.getItemColor(J.battledata[H[I]].tree)).show()}if(typeof J.battledata[H[I]].mount!="undefined"&&parseInt(J.battledata[H[I]].mount.id)>0){if(parseInt(J.battledata[H[I]].mount.quality)==8){G.find("."+O).find(".horse").css("color",helper.getItemColor(J.battledata[H[I]].mount.quality)).html('<span style="background-position:'+helper.getHorsePostion("buff",J.battledata[H[I]].mount.id)+';"></span><em class="colorwords">'+J.battledata[H[I]].mount.name+"</em>").show()}else{G.find("."+O).find(".horse").css("color",helper.getItemColor(J.battledata[H[I]].mount.quality)).html('<span style="background-position:'+helper.getHorsePostion("buff",J.battledata[H[I]].mount.id)+';"></span><em>'+J.battledata[H[I]].mount.name+"</em>").show()}}if(typeof J.battledata[H[I]].drum!="undefined"&&parseInt(J.battledata[H[I]].drum.id)>0){if(parseInt(J.battledata[H[I]].drum.quality)==8){G.find("."+O).find(".drum").css("color",helper.getItemColor(J.battledata[H[I]].drum.quality)).html('<span style="background-image:url('+xGame.drumurl(J.battledata[H[I]].drum.id)+');"></span><em class="colorwords">'+J.battledata[H[I]].drum.name+"</em>").show()}else{G.find("."+O).find(".drum").css("color",helper.getItemColor(J.battledata[H[I]].drum.quality)).html('<span style="background-image:url('+xGame.drumurl(J.battledata[H[I]].drum.id)+');"></span><em>'+J.battledata[H[I]].drum.name+"</em>").show()}}}}G.css({"background":"url("+ximg(J.bgname)+") 50% bottom no-repeat"});G=null}if(J.countrygvg!=null){$("#world").find("#battleworld_page #battle_vs").addClass("countrygvg_field");$("#world").find("#battleworld_page #battle_vs.countrygvg_field").find(".field_name").addClass("field"+J.fieldname);if(J.battledata!=J.countrygvg.report_list[0].battle){$("#world").find("#battleworld_page #countrygvg_change_hero").show()}}$("#worldloading").removeClass("black").hide();stage=stage||$("#container");J.initGroundSprites();if(J.countrygvg!=null){for(var K=0,B=J.countrygvg.country1_member;K<B.length;K++){if(J.countrygvg.country1_member[K].nickname==J.battledata.left_role.name){J.countrygvgteam("left",J.countrygvg.server1_name,J.countrygvg.country1_name,J.countrygvg.country1_member);J.countrygvgteam("right",J.countrygvg.server2_name,J.countrygvg.country2_name,J.countrygvg.country2_member)}if(J.countrygvg.country1_member[K].nickname==J.battledata.right_role.name){J.countrygvgteam("right",J.countrygvg.server1_name,J.countrygvg.country1_name,J.countrygvg.country1_member);J.countrygvgteam("left",J.countrygvg.server2_name,J.countrygvg.country2_name,J.countrygvg.country2_member)}}}this.timeoutArr.push(setTimeout(function(){if(J.battledata.process.length<=0){J.battleResult()}else{J.fight()}},400))},initGroundSprites:function(){var B=this;sprites={};sprites.left={};sprites.right={};for(p in B.battledata.leftteam){if(B.battledata.leftteam[p]==null){continue}var D=B.battledata.leftteam[p].image;var C=B.battledata.leftteam[p].name;sprites["left"][p]=new Hero({id:"left"+p,name:C,heroid:D,herodata:B.battledata.leftteam[p],pos:p,team:"left",heroid:D,heroimage:xGame.hero(D,1)});stage.append(sprites["left"][p].e);p=null;D=null}for(p in B.battledata.rightteam){if(B.battledata.rightteam[p]==null){continue}var D=B.battledata.rightteam[p].image+"";if(D.indexOf("worldboss")==0){var C=B.battledata.rightteam[p].name;sprites["right"][p]=new Boss({id:"right"+p,name:C,heroid:D,herodata:B.battledata.rightteam[p],pos:p,team:"right",heroid:D,heroimage:staticUrl+"img/worldboss/"+D+".png"})}else{if(D.indexOf("countryboss")==0){var C=B.battledata.rightteam[p].name;sprites["right"][p]=new Boss({id:"right"+p,name:C,heroid:D,herodata:B.battledata.rightteam[p],pos:p,team:"right",heroid:D,heroimage:staticUrl+"img/pop/"+D+"_stand.png"})}else{if(D.indexOf("newyearboss")==0){var C=B.battledata.rightteam[p].name;sprites["right"][p]=new Boss({id:"right"+p,name:C,heroid:D,herodata:B.battledata.rightteam[p],pos:p,team:"right",heroid:D,heroimage:ximg(staticUrl+"img/plugin/"+D+"_stand.png")})}else{if(D.indexOf("elk_boss")==0){var C=B.battledata.rightteam[p].name;sprites["right"][p]=new Boss({id:"right"+p,name:C,heroid:D,herodata:B.battledata.rightteam[p],pos:p,team:"right",heroid:D,heroimage:ximg(staticUrl+"img/plugin/"+D+"_stand.png")})}else{var C=B.battledata.rightteam[p].name;sprites["right"][p]=new Hero({id:"right"+p,name:C,heroid:D,herodata:B.battledata.rightteam[p],pos:p,team:"right",heroid:D,heroimage:xGame.hero(D,1)})}}}}stage.append(sprites["right"][p].e);p=null;D=null}for(var A in B.battledata.leftteam){if(B.battledata.leftteam[A].mingzhong_up&&B.battledata.leftteam[A].mingzhong_up==1){B.attrUp(12)}if(B.battledata.leftteam[A].jingzhun_up&&B.battledata.leftteam[A].jingzhun_up==1){B.attrUp(11)}}setTimeout(function(){B.drumup()},500)},attrUp:function(C){var B=this;var A="";A='<span class="drum drum_anim'+C+'" style="background:url('+xGame.drumupurl(C)+') left center no-repeat;"></span>';stage.find(".battle_sprite.leftteam .battle_attr_up").append(A);deleteThread=setTimeout(function(){xGame.doAnimate3(stage.find(".battle_attr_up"),"fadeOutUp","0.2s",function(){stage.find(".battle_attr_up").remove();stage.find(".battle_attr_up")=null})},500);A=null},drumup:function(){var B=this;if(B.battledata.leftdrum!=undefined&&B.battledata.leftdrum.type1!=undefined){var A="";var D="";for(var F=1;F<6;F++){if(parseInt(B.battledata.leftdrum["type"+F])!=0&&parseInt(B.battledata.leftdrum["range"+F])==1){var C=parseInt(B.battledata.leftdrum["type"+F]);A+='<span class="drum drum'+F+" drum_anim"+C+'" style="background:url('+xGame.drumupurl(C)+') left center no-repeat;"></span>'}else{if(parseInt(B.battledata.leftdrum["type"+F])!=0&&parseInt(B.battledata.leftdrum["range"+F])==2){var C=parseInt(B.battledata.leftdrum["type"+F]);D+='<span class="drum drum'+F+" drum_anim"+C+'" style="background:url('+xGame.drumupurl(C)+') left center no-repeat;"></span>'}}}stage.find(".battle_sprite.leftteam .drumChange_up").append(A);stage.find(".battle_sprite.leftteam .drummer_up").append(D);deleteThread=setTimeout(function(){xGame.doAnimate3(stage.find(".drumChange_up"),"fadeOutUp","0.4s",function(){stage.find(".drumChange_up").remove();stage.find(".drumChange_up")=null})},600);deleteThread2=setTimeout(function(){xGame.doAnimate3(stage.find(".drummer_up"),"fadeOutUp","0.4s",function(){stage.find(".drummer_up").remove();stage.find(".drummer_up")=null})},600);A=null;D=null}if(B.battledata.rightdrum!=undefined&&B.battledata.rightdrum.type1!=undefined){var A="";var D="";for(var E=1;E<6;E++){if(parseInt(B.battledata.rightdrum["type"+E])!=0&&parseInt(B.battledata.rightdrum["range"+E])==1){var C=parseInt(B.battledata.rightdrum["type"+E]);A+='<span class="drum drum'+E+" drum_anim"+C+'" style="background:url('+xGame.drumupurl(C)+') left center no-repeat;"></span>'}else{if(parseInt(B.battledata.rightdrum["type"+E])!=0&&parseInt(B.battledata.rightdrum["range"+E])==2){var C=parseInt(B.battledata.rightdrum["type"+E]);D+='<span class="drum drum'+E+" drum_anim"+C+'" style="background:url('+xGame.drumupurl(C)+') left center no-repeat;"></span>'}}}stage.find(".battle_sprite.rightteam .drumChange_up").append(A);stage.find(".battle_sprite.rightteam .drummer_up").append(D);deleteThread=setTimeout(function(){xGame.doAnimate3(stage.find(".drumChange_up"),"fadeOutUp","0.4s",function(){stage.find(".drumChange_up").remove();stage.find(".drumChange_up")=null})},600);deleteThread2=setTimeout(function(){xGame.doAnimate3(stage.find(".drummer_up"),"fadeOutUp","0.4s",function(){stage.find(".drummer_up").remove();stage.find(".drummer_up")=null})},600);A=null;D=null}},drumdrow:function(C){var B=this;if(C=="left"){if(B.battledata.leftdrum!=undefined&&B.battledata.leftdrum.type1!=undefined){var A="";for(var F=1;F<6;F++){if(parseInt(B.battledata.leftdrum["type"+F])!=0&&parseInt(B.battledata.leftdrum["range"+F])==1){var D=parseInt(B.battledata.leftdrum["type"+F]);A+='<span class="drum drum'+F+" drum_anim"+D+'" style="background:url('+xGame.drumdownurl(D)+') left center no-repeat;"></span>'}}stage.find(".battle_sprite.leftteam .drumChange_down").append(A);deleteThread=setTimeout(function(){xGame.doAnimate3(stage.find(".drumChange_down"),"fadeOutDown","0.4s",function(){stage.find(".drumChange_down").remove();stage.find(".drumChange_down")=null})},600);A=null}}else{if(B.battledata.rightdrum!=undefined&&B.battledata.rightdrum.type1!=undefined){var A="";for(var E=1;E<6;E++){if(parseInt(B.battledata.rightdrum["type"+E])!=0&&parseInt(B.battledata.rightdrum["range"+E])==1){var D=parseInt(B.battledata.rightdrum["type"+E]);A+='<span class="drum drum'+E+" drum_anim"+D+'" style="background:url('+xGame.drumdownurl(D)+') left center no-repeat;"></span>'}}stage.find(".battle_sprite.rightteam .drumChange_down").append(A);deleteThread=setTimeout(function(){xGame.doAnimate3(stage.find(".drumChange_down"),"fadeOutDown","0.4s",function(){stage.find(".drumChange_down").remove();stage.find(".drumChange_down")=null})},600);A=null}}},countrygvgteam:function(E,A,B,G){var D=this;var C="";C+='<div class="countrygvg_team '+E+'">';C+='<div class="country_name"><em>【'+A+"】</em>"+B+"</div>";C+='<div class="country_team_member">';for(var F=0;F<G.length;F++){C+="<span>Lv"+G[F].level+" "+G[F].nickname+"</span>"}C+="</div>";C+="</div>";$("#world").find("#battleworld_page").append(C)},showSkip:function(){var C=["left","right"];for(var A=0;A<C.length;A++){var D=C[A];for(x in sprites[D]){sprites[D][x]=null}sprites[D]=null}stage.find(".battle_sprite").remove();stage.find(".faint_wrap").remove();for(var A=0;A<C.length;A++){var D=C[A];sprites[D]={};for(p in this.skipresult[D]){var B=this.skipresult[D][p];var F=B.image+"";var E=B.name;if(F.indexOf("worldboss")==0){sprites["right"][p]=new Boss({id:"right"+p,name:E,heroid:F,herodata:B,pos:p,team:"right",heroid:F,heroimage:staticUrl+"img/worldboss/"+F+".png"})}else{if(F.indexOf("countryboss")==0){sprites["right"][p]=new Boss({id:"right"+p,name:E,heroid:F,herodata:B,pos:p,team:"right",heroid:F,heroimage:staticUrl+"img/pop/"+F+"_stand.png"})}else{if(F.indexOf("newyearboss")==0){sprites["right"][p]=new Boss({id:"right"+p,name:E,heroid:F,herodata:B,pos:p,team:"right",heroid:F,heroimage:ximg(staticUrl+"img/plugin/"+F+"_stand.png")})}else{if(F.indexOf("elk_boss")==0){sprites["right"][p]=new Boss({id:"right"+p,name:E,heroid:F,herodata:B,pos:p,team:"right",heroid:F,heroimage:ximg(staticUrl+"img/plugin/"+F+"_stand.png")})}else{sprites[D][p]=new Hero({id:D+""+p,name:E,heroid:F,herodata:B,pos:p,team:D,heroid:F,heroimage:xGame.hero(F,1)})}}}}stage.append(sprites[D][p].e);p=null;F=null;E=null}}},fight:function(){var A=this;if(A.skip==true){A.showSkip();A.k=0;A.battleResult();A=null;return}nowHero=null;nowHero={};A.timeoutArr.push(setTimeout(function(){var B=A.battledata.process[A.k];if(B){sprites[B.launch][B.attackor].toAttack(B);A.k++;if(B.round!=A.round){A.round=B.round;if(A.round!=1){A.afterRoundDeal("left");A.afterRoundDeal("right")}}}else{A.round=0;A.k=0;A.battleResult();A=null}},400))},battleResult:function(){var A=this;A.timeoutArr.push(setTimeout(function(){if(A.endfunc){A.endfunc()}else{A.callback()}A=null},500))},refight:function(){this.battledata=JSON.parse(this.battleStringData);nowHero=null;stage.empty();this.round=0;this.skip=false;$("#world #backbtn").attr("class",this.refightSkip==false?"btn disable":"btn show");this.allowSkip=this.refightSkip;this.initGroundSprites();this.fight();$("#backbtn").show()},clearLoseTeam:function(){var A=this.resultdata.win>0?".rightteam":".leftteam";stage.find(A).hide()},clearForContinue:function(){this.battledata=null;this.battleStringData=null;this.resultdata=null;this.callback=null;this.round=0;this.k=0;this.imagelist=null;this.skip=false;nowHero=null;stage.empty()},afterRoundDeal:function(C){var B=this;var D=sprites[C];for(var A in D){if(D[A]){D[A].reduceShieldRound();D[A].clearPenetrate();D[A].clearAtk();D[A].reduceyellowShieldRound();D[A].clearexacttarget()}}},unbindAll:function(){var A=$("#world");A.undelegate("#backbtn","touchend");A.undelegate("#skip_battle_tip","webkitAnimationEnd")},clear:function(){this.leave=true;if(this.t!=null){clearInterval(this.t);this.t=null}this.battledata=null;this.battleStringData=null;this.resultdata=null;this.callback=null;this.k=0;this.round=0;this.skip=false;this.skipresult=null;this.endfunc=null;this.allowSkip=true;this.refightSkip=true;this.unbindAll();clearInterval(fpsTimer);clearInterval(fpsTimer2);fpsContainer=null;fpsTimer=null;fpsTimer2=null;this.countrygvg=null;this.fieldname=null;this.nowdata=null;if(stage){stage.empty();stage=null}var B=["left","right"];for(var A=0;A<B.length;A++){var C=B[A];for(x in sprites[C]){sprites[C][x].clear()}}sprites=null;nowHero=null;this.imagelist=null;$("#battleworld_page").remove();if(gAudio){gAudio.playbgm("city_bgm")}for(var A=0;A<this.timeoutArr.length;A++){clearTimeout(this.timeoutArr[A])}this.timeoutArr.length=0},}})();function updatefn(){frames++};